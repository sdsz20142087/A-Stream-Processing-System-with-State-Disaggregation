version: '3'
name: "dataflow"
services:
  etcd:
    image: docker.io/bitnami/etcd:3.5
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
      - ETCD_LOG_LEVEL=warn
    volumes:
      - etcd_data:/bitnami/etcd
    ports:
        - '2379:2379'
        - '2380:2380'
  controlplane:
    build:
        context: .
        dockerfile: ControlPlaneDockerfile
    ports:
        - '8008:8008'
    links:
      - etcd
    depends_on:
      - etcd
  taskmanager:
    build:
        context: .
        dockerfile: TaskManagerDockerfile
    expose:
      - '8018'
    links:
      - controlplane
    depends_on:
      - controlplane
    deploy:
        replicas: 2

volumes:
  etcd_data:
    driver: local